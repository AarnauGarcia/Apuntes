En primer lugar tendremos que acceder a la máquina intermedia con una sesión de meterpreter.

[[eJPTv2/7. PIVOTING/Untitled Diagram.svg]]

Una vez dentro podremos hacer CNTRL + Z y dejar la sesión en segundo plano.

Una vez hecho esto buscaremos el siguiente modulo de metasploit:

`search windows/gather/arp_scanner`

Dentro de este nos pedirá la sesión y RHOSTS, en este caso tendremos que poner TODO el rango de IPS.

ej:

````
set RHOSTS 10.10.10.4/24
`````

Tras configurar estos parámetros podremos lanzarlo y nos dará un resultado similar al siguiente:

![[1.1. PIVOTING.png]]

Una vez encontrada la IP de la máquina víctima tendremos que enrutar el tráfico. Esto se hará mediante un modulo llamado autoroute
`use multi/manage/autoroute`

Nos pedirá únicamente el Session id

Una vez hecho esto tendremos ya el tráfico enrutado. Ahora pasamos al escaneo de puertos.

Se hará mediante el siguiente modulo:

`use scanner/portscan/tcp`

Tendremos que modificar el RHOSTS con tal de indicar la máquina que queremos escanear.

>[!note] ES POCO PROBABLE PERO PUEDE SER QUE TENGAMOS QUE CAMBIAR EL PARÁMETRO "PORTS" SI NOS PIDIERAN ALGO POR ENCIMA DE 10000 YA QUE POR DEFECTO REVISARÁ SOLO ESOS PUERTOS.

Posterior a saber los puertos tendremos que usar el siguiente modulo:

`use post/windows/manage/portproxy`

![[1.2. PIVOTING.png]]

- CONNECT_ADDRESS: IP máquina víctima
- CONNECT_PORT: Puerto al que queremos acceder/atacar.
- LOCAL_ADDRESS: SIEMPRE 0.0.0.0
- LOCAL_PORT: Puerto donde nos lo queramos traer.

